---
const redirectUrl = import.meta.env.PUBLIC_AUTH0_REDIRECT_URI;
const domain = import.meta.env.PUBLIC_AUTH0_DOMAIN;
const clientId = import.meta.env.PUBLIC_AUTH0_CLIENT_ID;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script is:inline src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  </head>
  <body>
    <div id="status">Redirecting...</div>
    <script is:inline define:vars={{ redirectUrl, domain, clientId }}>
      (async () => {
        try {
          console.log("Starting callback...");
          document.getElementById("status").textContent = "Loading Auth0...";
          
          // Wait for Auth0 SDK to load
          while (!window.auth0) {
            await new Promise(resolve => setTimeout(resolve, 50));
          }
          console.log("Auth0 SDK loaded");
          
          document.getElementById("status").textContent = "Processing callback...";
          
          const client = await window.auth0.createAuth0Client({
            domain: domain,
            clientId: clientId,
            authorizationParams: { redirect_uri: redirectUrl },
            cacheLocation: "localstorage",
            useRefreshTokens: true,
          });
          
          console.log("Handling redirect callback...");
          const result = await client.handleRedirectCallback();
          console.log("Callback result:", result);
          
          const returnTo = (result.appState?.returnTo) || "/";
          console.log("Redirecting to:", returnTo);
          
          window.location.replace(returnTo);
        } catch (err) {
          console.error("Callback error:", err);
          document.getElementById("status").textContent = "Error: " + err.message;
        }
      })();
    </script>
  </body>
</html>
