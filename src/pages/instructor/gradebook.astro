---
import CourseLayout from "../../layouts/CourseLayout.astro";
const title = "Instructor Gradebook";
const description = "Canvas-style gradebook with all student grades";
---

<CourseLayout title={title} description={description}>

<h1>üìä Course Gradebook</h1>

<div id="gradebook-container">
  <div id="loading-indicator" style="text-align: center; padding: 40px; color: #4ec9b0;">
    <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
    Loading gradebook data...
  </div>
  
  <div id="gradebook-content" style="display: none;">
    <!-- Filter controls -->
    <div id="gradebook-filters" style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
      <label style="color: #4ec9b0;">
        Week:
        <select id="week-filter" style="background: #1e1e1e; color: #fff; border: 1px solid #4ec9b0; padding: 6px 12px; border-radius: 4px; margin-left: 8px;">
          <option value="all">All Weeks</option>
        </select>
      </label>
      <label style="color: #4ec9b0;">
        Status:
        <select id="status-filter" style="background: #1e1e1e; color: #fff; border: 1px solid #4ec9b0; padding: 6px 12px; border-radius: 4px; margin-left: 8px;">
          <option value="all">All</option>
          <option value="passed">Passed</option>
          <option value="needs-work">Needs Work</option>
          <option value="not-started">Not Started</option>
        </select>
      </label>
      <button id="refresh-btn" style="background: #4ec9b0; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
        üîÑ Refresh
      </button>
      <span id="last-updated" style="color: #888; font-size: 0.85rem; margin-left: auto;"></span>
    </div>
    
    <!-- Gradebook table wrapper for horizontal scroll -->
    <div style="overflow-x: auto; border: 1px solid #333; border-radius: 8px;">
      <table id="gradebook-table" style="width: 100%; border-collapse: collapse; min-width: 800px;">
        <thead id="gradebook-header">
          <!-- Populated by JS -->
        </thead>
        <tbody id="gradebook-body">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
  </div>
  
  <div id="access-denied" style="display: none; text-align: center; padding: 40px; color: #ce9178;">
    <h2>‚ö†Ô∏è Instructor Access Required</h2>
    <p>You must be logged in with an @ccsnh.edu email (not @students.ccsnh.edu) to view the gradebook.</p>
  </div>
</div>

<!-- Submission Detail Modal -->
<div id="submission-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
  <div style="max-width: 800px; margin: 40px auto; background: #1e1e1e; border: 2px solid #4ec9b0; border-radius: 12px; position: relative;">
    <button id="modal-close" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">‚úï</button>
    
    <div style="padding: 20px; border-bottom: 1px solid #333;">
      <h2 style="margin: 0; color: #4ec9b0;" id="modal-title">Submission Details</h2>
      <p style="margin: 5px 0 0; color: #888;" id="modal-subtitle">Loading...</p>
    </div>
    
    <div id="modal-content" style="padding: 20px;">
      <!-- Score and status -->
      <div id="modal-score-section" style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 150px; background: #2d2d2d; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Current Score</div>
          <div id="modal-score" style="font-size: 2rem; font-weight: bold; color: #4ec9b0;">--</div>
        </div>
        <div style="flex: 1; min-width: 150px; background: #2d2d2d; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Status</div>
          <div id="modal-status" style="font-size: 1.2rem; font-weight: bold;">--</div>
        </div>
        <div style="flex: 1; min-width: 150px; background: #2d2d2d; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="color: #888; font-size: 0.85rem; margin-bottom: 5px;">Submitted</div>
          <div id="modal-timestamp" style="font-size: 0.9rem; color: #ddd;">--</div>
        </div>
      </div>
      
      <!-- Student Code -->
      <details open style="margin-bottom: 20px;">
        <summary style="cursor: pointer; color: #4ec9b0; font-weight: bold; padding: 10px 0;">üìù Student Submission</summary>
        <pre id="modal-code" style="background: #0d0d0d; padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; color: #ddd; max-height: 300px; overflow-y: auto; margin-top: 10px;">No code available</pre>
      </details>
      
      <!-- AI Feedback -->
      <details open style="margin-bottom: 20px;">
        <summary style="cursor: pointer; color: #4ec9b0; font-weight: bold; padding: 10px 0;">ü§ñ AI Feedback</summary>
        <div id="modal-feedback" style="background: #0d0d0d; padding: 15px; border-radius: 8px; color: #ddd; margin-top: 10px;">
          No AI feedback available
        </div>
      </details>
      
      <!-- Instructor Actions -->
      <div style="border-top: 1px solid #333; padding-top: 20px; margin-top: 20px;">
        <h3 style="color: #ce9178; margin-top: 0;">‚öôÔ∏è Instructor Actions</h3>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <!-- Manual Grade Override -->
          <div style="flex: 1; min-width: 250px; background: #2d2d2d; padding: 15px; border-radius: 8px;">
            <label style="display: block; margin-bottom: 10px; color: #ddd;">
              Manual Grade Override:
              <input type="number" id="manual-grade-input" min="0" max="100" placeholder="0-100" 
                style="display: block; width: 100%; margin-top: 5px; padding: 8px; background: #1e1e1e; border: 1px solid #4ec9b0; border-radius: 4px; color: #fff;">
            </label>
            <label style="display: block; margin-bottom: 10px; color: #ddd;">
              Reason (optional):
              <input type="text" id="override-reason" placeholder="e.g., Extended time, resubmission..." 
                style="display: block; width: 100%; margin-top: 5px; padding: 8px; background: #1e1e1e; border: 1px solid #666; border-radius: 4px; color: #fff;">
            </label>
            <button id="apply-override-btn" style="background: #ce9178; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">
              Apply Override
            </button>
          </div>
          
          <!-- Allow Retry -->
          <div style="flex: 1; min-width: 250px; background: #2d2d2d; padding: 15px; border-radius: 8px;">
            <p style="color: #ddd; margin-top: 0;">Allow the student to resubmit this assignment:</p>
            <button id="allow-retry-btn" style="background: #569cd6; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%;">
              üîÑ Allow Retry
            </button>
            <p style="color: #888; font-size: 0.8rem; margin-top: 10px;">
              This will reset the assignment status to "in_progress" and clear the current score.
            </p>
          </div>
        </div>
        
        <div id="action-feedback" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
      </div>
    </div>
  </div>
</div>

<style>
  #gradebook-table th, #gradebook-table td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid #333;
  }
  
  #gradebook-table th {
    background: #2d2d2d;
    color: #4ec9b0;
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  #gradebook-table th:first-child {
    text-align: left;
    position: sticky;
    left: 0;
    z-index: 20;
    background: #2d2d2d;
  }
  
  #gradebook-table td:first-child {
    text-align: left;
    position: sticky;
    left: 0;
    background: #1e1e1e;
    z-index: 5;
    min-width: 200px;
  }
  
  #gradebook-table tr:hover td {
    background: #2a2a2a;
  }
  
  #gradebook-table tr:hover td:first-child {
    background: #2a2a2a;
  }
  
  .grade-cell {
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 4px;
    transition: all 0.2s;
    display: inline-block;
    min-width: 50px;
  }
  
  .grade-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(78, 201, 176, 0.5);
  }
  
  .grade-passed {
    background: rgba(78, 201, 176, 0.2);
    color: #4ec9b0;
    border: 1px solid #4ec9b0;
  }
  
  .grade-attempted {
    background: rgba(206, 145, 120, 0.2);
    color: #ce9178;
    border: 1px solid #ce9178;
  }
  
  .grade-not-started {
    background: rgba(100, 100, 100, 0.2);
    color: #888;
    border: 1px solid #555;
  }
  
  .student-name {
    font-weight: bold;
    color: #ddd;
  }
  
  .student-email {
    font-size: 0.8rem;
    color: #888;
  }
</style>

<script>
  // Assignment definitions - weeks and their assignments
  const ASSIGNMENTS = [
    { id: 'week-01-required-quiz', label: 'W1 Quiz', week: 1 },
    { id: 'week-01-homework', label: 'W1 HW', week: 1 },
    { id: 'week-01-lab', label: 'W1 Lab', week: 1 },
    { id: 'week-02-quiz', label: 'W2 Quiz', week: 2 },
    { id: 'week-02-homework', label: 'W2 HW', week: 2 },
    { id: 'week-02-lab', label: 'W2 Lab', week: 2 },
    { id: 'week-03-quiz', label: 'W3 Quiz', week: 3 },
    { id: 'week-03-homework', label: 'W3 HW', week: 3 },
    { id: 'week-03-lab', label: 'W3 Lab', week: 3 },
    { id: 'week-04-quiz', label: 'W4 Quiz', week: 4 },
    { id: 'week-04-homework', label: 'W4 HW', week: 4 },
    { id: 'week-04-lab', label: 'W4 Lab', week: 4 },
    { id: 'week-05-quiz', label: 'W5 Quiz', week: 5 },
    { id: 'week-05-homework', label: 'W5 HW', week: 5 },
    { id: 'week-05-lab', label: 'W5 Lab', week: 5 },
  ];
  
  let allStudents = [];
  let currentStudent = null;
  let currentAssignment = null;
  
  async function getAuthToken() {
    // Try to get token from Auth0 SDK first
    if (window.__auth) {
      try {
        return await window.__auth.getAccessToken();
      } catch (e) {
        console.error('[Gradebook] Failed to get token from Auth0:', e);
      }
    }
    // Fallback to localStorage
    return localStorage.getItem('access_token');
  }
  
  async function getAuthHeaders() {
    const token = await getAuthToken();
    return token ? { 'Authorization': `Bearer ${token}` } : {};
  }
  
  function parseProgressData(progress) {
    // Parse the hash-style progress data into usable format
    const parsed = {};
    
    for (const [key, value] of Object.entries(progress || {})) {
      // Keys look like: "week-01-homework:score", "week-01-homework:status"
      const parts = key.split(':');
      if (parts.length >= 2) {
        const field = parts.pop();
        const pageId = parts.join(':');
        
        if (!parsed[pageId]) {
          parsed[pageId] = {};
        }
        
        if (field === 'score') {
          parsed[pageId].score = parseFloat(value) || 0;
        } else {
          parsed[pageId][field] = value;
        }
      }
    }
    
    return parsed;
  }
  
  async function loadGradebook() {
    const loading = document.getElementById('loading-indicator');
    const content = document.getElementById('gradebook-content');
    const denied = document.getElementById('access-denied');
    
    loading.style.display = 'block';
    content.style.display = 'none';
    denied.style.display = 'none';
    
    try {
      const headers = await getAuthHeaders();
      if (!headers.Authorization) {
        throw new Error('Not authenticated');
      }
      
      const res = await fetch('/.netlify/functions/instructor-progress', { headers });
      
      if (res.status === 403) {
        loading.style.display = 'none';
        denied.style.display = 'block';
        return;
      }
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const data = await res.json();
      allStudents = data.students || [];
      
      // Parse progress data for each student
      allStudents.forEach(student => {
        student.parsedProgress = parseProgressData(student.progress);
      });
      
      renderGradebook();
      
      loading.style.display = 'none';
      content.style.display = 'block';
      
      document.getElementById('last-updated').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
      
    } catch (err) {
      console.error('[Gradebook] Load error:', err);
      loading.innerHTML = `<div style="color: #ce9178;">Error loading gradebook: ${err.message}</div>`;
    }
  }
  
  function renderGradebook() {
    const header = document.getElementById('gradebook-header');
    const body = document.getElementById('gradebook-body');
    
    // Build header row
    let headerHtml = '<tr><th>Student</th>';
    ASSIGNMENTS.forEach(a => {
      headerHtml += `<th title="${a.id}">${a.label}</th>`;
    });
    headerHtml += '</tr>';
    header.innerHTML = headerHtml;
    
    // Populate week filter
    const weekFilter = document.getElementById('week-filter');
    const weeks = [...new Set(ASSIGNMENTS.map(a => a.week))];
    weekFilter.innerHTML = '<option value="all">All Weeks</option>' + 
      weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
    
    // Build body rows
    let bodyHtml = '';
    
    if (allStudents.length === 0) {
      bodyHtml = `<tr><td colspan="${ASSIGNMENTS.length + 1}" style="text-align: center; color: #888; padding: 40px;">No student data yet</td></tr>`;
    } else {
      allStudents.forEach(student => {
        const displayName = student.name || student.email?.split('@')[0] || 'Unknown';
        
        bodyHtml += `<tr data-student-id="${student.sub}">`;
        bodyHtml += `<td>
          <div class="student-name">${displayName}</div>
          <div class="student-email">${student.email || ''}</div>
        </td>`;
        
        ASSIGNMENTS.forEach(a => {
          const progress = student.parsedProgress?.[a.id] || {};
          const score = progress.score;
          const status = progress.status;
          
          let cellClass = 'grade-not-started';
          let cellContent = '-';
          
          if (score !== undefined && score !== null) {
            cellContent = `${score}%`;
            cellClass = score >= 70 ? 'grade-passed' : 'grade-attempted';
          } else if (status === 'in_progress' || status === 'attempted') {
            cellContent = '...';
            cellClass = 'grade-attempted';
          }
          
          bodyHtml += `<td>
            <span class="grade-cell ${cellClass}" 
                  data-student-id="${student.sub}" 
                  data-assignment-id="${a.id}"
                  data-student-email="${student.email || ''}"
                  onclick="openSubmissionModal('${student.sub}', '${a.id}', '${student.email || ''}')">
              ${cellContent}
            </span>
          </td>`;
        });
        
        bodyHtml += '</tr>';
      });
    }
    
    body.innerHTML = bodyHtml;
  }
  
  // Make openSubmissionModal global
  window.openSubmissionModal = async function(studentId, assignmentId, studentEmail) {
    currentStudent = studentId;
    currentAssignment = assignmentId;
    
    const modal = document.getElementById('submission-modal');
    const title = document.getElementById('modal-title');
    const subtitle = document.getElementById('modal-subtitle');
    const scoreEl = document.getElementById('modal-score');
    const statusEl = document.getElementById('modal-status');
    const timestampEl = document.getElementById('modal-timestamp');
    const codeEl = document.getElementById('modal-code');
    const feedbackEl = document.getElementById('modal-feedback');
    const actionFeedback = document.getElementById('action-feedback');
    
    // Reset
    title.textContent = `Submission: ${assignmentId}`;
    subtitle.textContent = studentEmail;
    scoreEl.textContent = '--';
    statusEl.textContent = '--';
    timestampEl.textContent = '--';
    codeEl.textContent = 'Loading...';
    feedbackEl.textContent = 'Loading...';
    actionFeedback.style.display = 'none';
    document.getElementById('manual-grade-input').value = '';
    document.getElementById('override-reason').value = '';
    
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Find student data
    const student = allStudents.find(s => s.sub === studentId);
    if (!student) {
      codeEl.textContent = 'Student not found';
      feedbackEl.textContent = 'N/A';
      return;
    }
    
    const progress = student.parsedProgress?.[assignmentId] || {};
    
    // Display score and status
    if (progress.score !== undefined) {
      scoreEl.textContent = `${progress.score}%`;
      scoreEl.style.color = progress.score >= 70 ? '#4ec9b0' : '#ce9178';
    }
    
    if (progress.status) {
      statusEl.textContent = progress.status;
      statusEl.style.color = progress.status === 'passed' || progress.status === 'completed' ? '#4ec9b0' : '#ce9178';
    }
    
    if (progress.submittedAt) {
      timestampEl.textContent = new Date(progress.submittedAt).toLocaleString();
    }
    
    // Display saved code
    const savedCode = student.progress?.[`${assignmentId}:savedCode`] || progress.savedCode;
    codeEl.textContent = savedCode || 'No saved code available';
    
    // Display AI feedback
    const feedback = student.progress?.[`${assignmentId}:feedback`] || progress.feedback;
    feedbackEl.textContent = feedback || 'No AI feedback available';
  };
  
  function closeModal() {
    document.getElementById('submission-modal').style.display = 'none';
    document.body.style.overflow = '';
    currentStudent = null;
    currentAssignment = null;
  }
  
  async function applyOverride() {
    if (!currentStudent || !currentAssignment) return;
    
    const scoreInput = document.getElementById('manual-grade-input');
    const reasonInput = document.getElementById('override-reason');
    const actionFeedback = document.getElementById('action-feedback');
    
    const newScore = parseInt(scoreInput.value);
    if (isNaN(newScore) || newScore < 0 || newScore > 100) {
      actionFeedback.textContent = 'Please enter a valid score (0-100)';
      actionFeedback.style.display = 'block';
      actionFeedback.style.background = '#ce9178';
      actionFeedback.style.color = '#000';
      return;
    }
    
    try {
      const headers = await getAuthHeaders();
      headers['Content-Type'] = 'application/json';
      
      const res = await fetch('/.netlify/functions/manual-override', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          userId: currentStudent,
          pageId: currentAssignment,
          newScore,
          reason: reasonInput.value || 'Manual instructor override'
        })
      });
      
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Override failed');
      }
      
      actionFeedback.textContent = `‚úì Score updated to ${newScore}%`;
      actionFeedback.style.display = 'block';
      actionFeedback.style.background = '#4ec9b0';
      actionFeedback.style.color = '#000';
      
      // Refresh gradebook
      setTimeout(() => {
        closeModal();
        loadGradebook();
      }, 1500);
      
    } catch (err) {
      actionFeedback.textContent = `Error: ${err.message}`;
      actionFeedback.style.display = 'block';
      actionFeedback.style.background = '#ce9178';
      actionFeedback.style.color = '#000';
    }
  }
  
  async function allowRetry() {
    if (!currentStudent || !currentAssignment) return;
    
    const actionFeedback = document.getElementById('action-feedback');
    
    try {
      const headers = await getAuthHeaders();
      headers['Content-Type'] = 'application/json';
      
      // Use manual-override to set status back to in_progress with score 0
      const res = await fetch('/.netlify/functions/manual-override', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          userId: currentStudent,
          pageId: currentAssignment,
          newScore: 0,
          reason: 'Instructor allowed retry - previous submission cleared'
        })
      });
      
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || 'Allow retry failed');
      }
      
      actionFeedback.textContent = '‚úì Student can now retry this assignment';
      actionFeedback.style.display = 'block';
      actionFeedback.style.background = '#569cd6';
      actionFeedback.style.color = '#fff';
      
      // Refresh gradebook
      setTimeout(() => {
        closeModal();
        loadGradebook();
      }, 1500);
      
    } catch (err) {
      actionFeedback.textContent = `Error: ${err.message}`;
      actionFeedback.style.display = 'block';
      actionFeedback.style.background = '#ce9178';
      actionFeedback.style.color = '#000';
    }
  }
  
  // Event listeners
  document.getElementById('modal-close').addEventListener('click', closeModal);
  document.getElementById('submission-modal').addEventListener('click', (e) => {
    if (e.target.id === 'submission-modal') closeModal();
  });
  document.getElementById('apply-override-btn').addEventListener('click', applyOverride);
  document.getElementById('allow-retry-btn').addEventListener('click', allowRetry);
  document.getElementById('refresh-btn').addEventListener('click', loadGradebook);
  
  // Keyboard shortcut to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
  
  // Wait for auth to be ready, then load
  async function init() {
    let attempts = 0;
    while (!window.__auth && attempts < 50) {
      await new Promise(r => setTimeout(r, 100));
      attempts++;
    }
    loadGradebook();
  }
  
  init();
</script>

</CourseLayout>
