---
import CourseLayout from "../../layouts/CourseLayout.astro";
import { COURSE } from "../../config/site";

const title = "Instructor Dashboard";
const description = "View student progress and activity";
---

<CourseLayout title={title} description={description}>
  <h1>Instructor Dashboard</h1>
  <p class="hint">Faculty-only view of student progress.</p>

  <div id="auth-check" style="margin: 20px 0;">
    <p>Checking authorization...</p>
  </div>

  <div id="dashboard-content" style="display: none;">
    <div style="margin: 20px 0; display: flex; gap: 12px; flex-wrap: wrap;">
      <div>
        <label for="status-filter" style="margin-right: 8px;">Status:</label>
        <select id="status-filter" class="filter-select">
          <option value="all">All</option>
          <option value="active">Has Activity</option>
          <option value="completed">Has Completed</option>
          <option value="in-progress">Has In Progress</option>
        </select>
      </div>
      
      <div>
        <label for="week-filter" style="margin-right: 8px;">Week:</label>
        <select id="week-filter" class="filter-select">
          <option value="all">All Weeks</option>
          <option value="01">Week 1</option>
          <option value="02">Week 2</option>
          <option value="03">Week 3</option>
          <option value="04">Week 4</option>
          <option value="05">Week 5</option>
          <option value="06">Week 6</option>
          <option value="07">Week 7</option>
          <option value="08">Week 8</option>
          <option value="09">Week 9</option>
          <option value="10">Week 10</option>
          <option value="11">Week 11</option>
          <option value="12">Week 12</option>
          <option value="13">Week 13</option>
          <option value="14">Week 14</option>
          <option value="15">Week 15</option>
          <option value="16">Week 16</option>
        </select>
      </div>
    </div>

    <div id="loading" style="margin: 20px 0;">
      <p>Loading student data...</p>
    </div>

    <div id="error" style="display: none; color: #ef4444; margin: 20px 0;"></div>

    <div id="stats" style="margin: 20px 0; display: none;">
      <strong>Total Students: <span id="total-students">0</span></strong>
    </div>

    <div style="overflow-x: auto;">
      <table id="student-table" style="display: none; width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid var(--border);">
            <th style="text-align: left; padding: 12px;">Email</th>
            <th style="text-align: center; padding: 12px;">Completed</th>
            <th style="text-align: center; padding: 12px;">In Progress</th>
            <th style="text-align: left; padding: 12px;">Last Active</th>
            <th style="text-align: center; padding: 12px;">HW Analysis</th>
          </tr>
        </thead>
        <tbody id="student-tbody">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (async () => {
      const authCheck = document.getElementById('auth-check');
      const dashboardContent = document.getElementById('dashboard-content');
      const loading = document.getElementById('loading');
      const errorDiv = document.getElementById('error');
      const stats = document.getElementById('stats');
      const table = document.getElementById('student-table');
      const tbody = document.getElementById('student-tbody');
      const totalStudentsSpan = document.getElementById('total-students');
      const statusFilter = document.getElementById('status-filter');
      const weekFilter = document.getElementById('week-filter');

      let allStudents = [];
      
      // Wait for auth
      const waitForAuth = async () => {
        let attempts = 0;
        while (!window.__auth) {
          if (attempts++ > 100) throw new Error('Auth not available');
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      };

      try {
        await waitForAuth();
        
        const authed = await window.__auth.isAuthed();
        if (!authed) {
          authCheck.innerHTML = '<p style="color: #ef4444;">Please sign in to access the instructor dashboard.</p>';
          return;
        }

        const user = await window.__auth.getUser();
        if (!user || !user.email || user.email !== COURSE.instructorEmail) {
          authCheck.innerHTML = '<p style="color: #ef4444;">Not authorized. Faculty access only.</p>';
          return;
        }

        // Authorized - show dashboard
        authCheck.style.display = 'none';
        dashboardContent.style.display = 'block';

        // Fetch student data
        const token = await window.__auth.getAccessToken();
        const response = await fetch('/api/instructor-progress', {
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        allStudents = data.students || [];
        
        loading.style.display = 'none';
        stats.style.display = 'block';
        table.style.display = 'table';
        
        renderTable();
        
        // Add filter listeners
        statusFilter.addEventListener('change', renderTable);
        weekFilter.addEventListener('change', renderTable);
        
      } catch (err) {
        console.error('[Instructor] Error:', err);
        authCheck.style.display = 'none';
        dashboardContent.style.display = 'block';
        loading.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.textContent = `Error loading dashboard: ${err.message}`;
      }

      function countByStatus(progress, status) {
        if (!progress || typeof progress !== 'object') return 0;
        return Object.values(progress).filter(entry => entry.status === status).length;
      }

      function filterByWeek(progress, week) {
        if (!progress || typeof progress !== 'object') return {};
        const filtered = {};
        for (const [key, value] of Object.entries(progress)) {
          if (key.includes(`week-${week}`)) {
            filtered[key] = value;
          }
        }
        return filtered;
      }

      function renderTable() {
        const statusValue = statusFilter.value;
        const weekValue = weekFilter.value;
        
        let filtered = allStudents;
        
        // Apply status filter
        if (statusValue !== 'all') {
          filtered = filtered.filter(student => {
            if (statusValue === 'active') {
              return student.lastActive !== null;
            } else if (statusValue === 'completed') {
              return countByStatus(student.progress, 'completed') > 0;
            } else if (statusValue === 'in-progress') {
              return countByStatus(student.progress, 'in_progress') > 0;
            }
            return true;
          });
        }
        
        tbody.innerHTML = '';
        
        filtered.forEach(student => {
          const progress = weekValue === 'all' 
            ? student.progress 
            : filterByWeek(student.progress, weekValue);
          
          const completedCount = countByStatus(progress, 'completed');
          const inProgressCount = countByStatus(progress, 'in_progress');
          
          const lastActive = student.lastActive 
            ? new Date(student.lastActive).toLocaleString() 
            : 'Never';
          
          const hwFeedback = student.progress?.['week-01-homework:feedback'] || 'No analysis recorded.';
          const escapedFeedback = hwFeedback.replace(/`/g, "'").replace(/\\/g, "\\\\").replace(/\n/g, "\\n");
          
          const row = document.createElement('tr');
          row.style.borderBottom = '1px solid var(--border)';
          row.innerHTML = `
            <td style="padding: 12px;">${student.email}</td>
            <td style="padding: 12px; text-align: center;">${completedCount}</td>
            <td style="padding: 12px; text-align: center;">${inProgressCount}</td>
            <td style="padding: 12px;">${lastActive}</td>
            <td style="padding: 12px; text-align: center;">
              <button 
                onclick="alert('AI ANALYSIS FOR ${student.email}:\\n\\n${escapedFeedback}')"
                style="font-size: 0.75rem; color: #4ec9b0; background: none; border: none; cursor: pointer; text-decoration: underline;"
              >
                VIEW ANALYSIS
              </button>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        totalStudentsSpan.textContent = filtered.length;
      }
    })();
  </script>

  <style>
    .filter-select {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-size: 14px;
    }
    
    table {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th {
      background: var(--panel2);
      font-weight: 600;
      color: var(--text);
    }
    
    td {
      color: var(--text);
    }
    
    tr:hover {
      background: var(--navitem-hover);
    }
  </style>
</CourseLayout>
