---
import "../styles/global.css";
import { COURSE, WEEKS } from "../config/site";
const { title = "Course Page", description = "" } = Astro.props;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} • {COURSE.code}</title>
    {description ? <meta name="description" content={description} /> : null}
  </head>
  <body>
    <div class="container">
      <div class="shell">
        <aside class="card sidebar">
          <div style="display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;">
            <h2 style="margin:0; font-size:16px;">{COURSE.code}</h2>
            <span class="badge">{COURSE.title}</span>
          </div>
          <p class="hint" style="margin:10px 0 0;">
            {COURSE.term} • CRN {COURSE.crn}<br/>
            Contact: <a href={`mailto:${COURSE.instructorEmail}`}>{COURSE.instructorEmail}</a>
          </p>

          <hr />

          <nav>
            <div class="hint" style="margin-bottom:8px;">Weeks</div>
            <ul class="navlist">
              {WEEKS.map((w) => (
                <li class="navitem">
                  <a href={w.href}>
                    <strong>Week {w.n}</strong><br/>
                    <span class="hint" style="font-size:12px;">Lesson 1 • Lesson 2 • Extra</span>
                  </a>
                </li>
              ))}
            </ul>
          </nav>

          <hr />

          <div class="hint">
            <a href="/editor/">Open Browser Code Editor</a>
          </div>
          <div class="hint" style="margin-top:8px;">
            <span style="opacity:.9;">Progress is saved on this device.</span>
          </div>
        </aside>

        <main class="card main">
          <slot />
        </main>
      </div>
    </div>

    <!-- Simple local progress tracker (no login). -->
    <script is:inline>
      (() => {
        const KEY = "cis118m_progress_v1";

        const safeJsonParse = (s) => {
          try { return JSON.parse(s); } catch { return null; }
        };

        const load = () => {
          try {
            const raw = localStorage.getItem(KEY);
            const obj = raw ? safeJsonParse(raw) : null;
            if (obj && typeof obj === "object") return obj;
          } catch {}
          return { weeks: {} };
        };

        const save = (data) => {
          try { localStorage.setItem(KEY, JSON.stringify(data)); } catch {}
        };

        const ensureWeek = (data, week) => {
          data.weeks ||= {};
          data.weeks[week] ||= { viewed: {}, selfMarked: {}, lastUpdated: new Date().toISOString() };
          data.weeks[week].viewed ||= {};
          data.weeks[week].selfMarked ||= {};
          return data.weeks[week];
        };

        const getWeekAndSlugFromPath = () => {
          const path = window.location.pathname;
          const m = path.match(/^\/week-(\d{2})\/(.*)$/);
          if (!m) return null;
          const week = m[1];
          const rest = (m[2] || "").replace(/\/+$/, "");
          const slug = rest === "" ? "index" : rest.split("/")[0];
          return { week, slug };
        };

        const markViewed = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week, slug } = info;
          const data = load();
          const w = ensureWeek(data, week);
          const trackable = new Set(["lesson-1","lesson-2","extra-practice","lab","homework","index"]);
          if (trackable.has(slug)) {
            w.viewed[slug] = true;
            w.lastUpdated = new Date().toISOString();
            save(data);
          }
        };

        const applyProgressBadges = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week } = info;
          const data = load();
          const w = ensureWeek(data, week);

          document.querySelectorAll("[data-progress-slug]").forEach((el) => {
            const slug = el.getAttribute("data-progress-slug");
            const kind = el.getAttribute("data-progress-kind") || "viewed"; // viewed | selfMarked
            const done = kind === "selfMarked" ? !!w.selfMarked?.[slug] : !!w.viewed?.[slug];

            el.textContent = done ? "✅ Done" : "⬜ Not yet";
            el.setAttribute("aria-label", done ? "Done" : "Not yet");
            el.style.fontWeight = "600";
            el.style.opacity = done ? "1" : ".85";
          });
        };

        const wireMarkCompleteButtons = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week } = info;

          document.querySelectorAll("[data-mark-complete]").forEach((btn) => {
            const slug = btn.getAttribute("data-mark-complete");
            btn.addEventListener("click", () => {
              const data = load();
              const w = ensureWeek(data, week);
              w.selfMarked[slug] = true;
              w.lastUpdated = new Date().toISOString();
              save(data);
              applyProgressBadges();
              btn.disabled = true;
              btn.textContent = "Marked complete ✅";
            });

            const data = load();
            const w = ensureWeek(data, week);
            if (w.selfMarked?.[slug]) {
              btn.disabled = true;
              btn.textContent = "Marked complete ✅";
            }
          });
        };

        document.addEventListener("DOMContentLoaded", () => {
          markViewed();
          applyProgressBadges();
          wireMarkCompleteButtons();
        });
      })();
    </script>
  </body>
</html>
