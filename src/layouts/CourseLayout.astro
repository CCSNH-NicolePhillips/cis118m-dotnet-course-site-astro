---
import "../styles/global.css";
import { COURSE, WEEKS } from "../config/site";
const { title = "Course Page", description = "" } = Astro.props;
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} â€¢ {COURSE.code}</title>
    {description ? <meta name="description" content={description} /> : null}
    <script is:inline src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script is:inline src="/monaco/vs/loader.js"></script>
    <script is:inline>
      require.config({ paths: { vs: '/monaco/vs' } });
      require(['vs/editor/editor.main'], function() {
        console.log('[Monaco] Editor loaded successfully');
      });
    </script>
  </head>
  <body>
    <div class="container">
      <div class="shell">
        <aside class="card sidebar" id="sidebar">
          <button class="sidebar-collapse-btn" id="sidebar-toggle" type="button" aria-label="Collapse sidebar" title="Collapse sidebar">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="sidebar-content" id="sidebar-content">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div style="display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;">
              <h2 style="margin:0; font-size:16px;">{COURSE.code}</h2>
              <span class="badge">{COURSE.title}</span>
            </div>
            <button class="sidebar-pin-btn" id="sidebar-pin" type="button" aria-label="Pin sidebar" title="Pin sidebar">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9.5 2.5L8 1L4 5L5.5 6.5L3 9L5 11L7.5 8.5L9 10L13 6L11.5 4.5L9.5 2.5Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                <path d="M5 11L2 14" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          
          <p class="hint" style="margin:10px 0 0;">
            {COURSE.term} â€¢ CRN {COURSE.crn}<br/>
            Contact: <a href={`mailto:${COURSE.instructorEmail}`}>{COURSE.instructorEmail}</a>
          </p>

          <hr />

          <nav>
            <div class="hint" style="margin-bottom:8px;">Weeks</div>
            <div class="week-menu">
              {WEEKS.map((w) => (
                <div class="week-item" data-week={w.slug}>
                  <button 
                    class="week-header" 
                    type="button"
                    aria-expanded="false"
                    aria-controls={`week-${w.slug}-content`}
                    data-week={w.slug}
                  >
                    <span class="week-title">Week {w.n}</span>
                    <svg class="week-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <div class="week-content" id={`week-${w.slug}-content`}>
                    <ul class="week-links">
                      {w.slug === '01' ? (
                        <>
                          <li>
                            <a href={`/week-${w.slug}/start-here/`} data-page={`/week-${w.slug}/start-here/`}>
                              <span class="lesson-text">01. Start Here & Syllabus</span>
                            </a>
                          </li>
                          <li>
                            <a href={w.lesson1} data-page={w.lesson1} data-starter={`week-${w.slug}-lesson-1`}>
                              <span class="lesson-text">02. Lesson: The Spark</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-lesson-1`}></span>
                            </a>
                          </li>
                          <li>
                            <a href={`/week-${w.slug}/lab-01/`} data-page={`/week-${w.slug}/lab-01/`}>
                              <span class="lesson-text">03. Lab: Welcome Protocol</span>
                            </a>
                          </li>
                          <li>
                            <a href={`/week-${w.slug}/homework/`} data-page={`/week-${w.slug}/homework/`}>
                              <span class="lesson-text">04. Homework: Reflection</span>
                            </a>
                          </li>
                        </>
                      ) : w.slug === '02' ? (
                        <>
                          <li>
                            <a href={w.lesson1} data-page={w.lesson1} data-starter={`week-${w.slug}-lesson-1`}>
                              <span class="lesson-text">Lesson 1: Memory & Variables</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-lesson-1`}></span>
                            </a>
                          </li>
                          <li>
                            <a href={w.lesson2} data-page={w.lesson2} data-starter={`week-${w.slug}-lesson-2`}>
                              <span class="lesson-text">Lesson 2</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-lesson-2`}></span>
                            </a>
                          </li>
                          <li>
                            <a href={w.extra} data-page={w.extra} data-starter={`week-${w.slug}-extra-practice`}>
                              <span class="lesson-text">Extra Practice</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-extra-practice`}></span>
                            </a>
                          </li>
                        </>
                      ) : (
                        <>
                          <li>
                            <a href={w.lesson1} data-page={w.lesson1} data-starter={`week-${w.slug}-lesson-1`}>
                              <span class="lesson-text">Lesson 1</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-lesson-1`}></span>
                            </a>
                          </li>
                          <li>
                            <a href={w.lesson2} data-page={w.lesson2} data-starter={`week-${w.slug}-lesson-2`}>
                              <span class="lesson-text">Lesson 2</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-lesson-2`}></span>
                            </a>
                          </li>
                          <li>
                            <a href={w.extra} data-page={w.extra} data-starter={`week-${w.slug}-extra-practice`}>
                              <span class="lesson-text">Extra Practice</span>
                              <span class="lesson-status" data-starter={`week-${w.slug}-extra-practice`}></span>
                            </a>
                          </li>
                        </>
                      )}
                    </ul>
                  </div>
                </div>
              ))}
            </div>
          </nav>

          <hr />

          <div class="hint">
            <a href="/editor/">Open Browser Code Editor</a>
          </div>
          <div class="hint" style="margin-top:8px;">
            <span style="opacity:.9;">Progress is saved on this device.</span>
          </div>
          </div>
          <button class="sidebar-expand-btn" id="sidebar-expand" type="button" aria-label="Expand sidebar" title="Expand sidebar">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </aside>

        <div class="main-wrapper">
          <header class="top-header">
            <div class="header-spacer"></div>
            <button id="theme-toggle-btn" class="theme-toggle-btn" type="button" title="Toggle theme" aria-label="Toggle theme">
              <span id="theme-icon">ðŸŒ™</span>
            </button>
            <div class="auth-header">
              <!-- Logged out state -->
              <button data-auth="login" type="button" class="btn-primary auth-signin">Sign in</button>
              
              <!-- Logged in state -->
              <button data-auth="user-chip" class="user-chip" style="display:none;" aria-haspopup="menu" aria-expanded="false">
                <svg class="user-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                  <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 1c-2.67 0-8 1.34-8 4v1h16v-1c0-2.66-5.33-4-8-4z" fill="currentColor"/>
                </svg>
                <span data-auth="user-email" class="user-email"></span>
                <svg class="chevron-icon" width="14" height="14" viewBox="0 0 16 16" fill="none" aria-hidden="true">
                  <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <div data-auth="dropdown-menu" class="dropdown-menu" role="menu" style="display:none;">
                <button data-auth="logout" type="button" class="dropdown-item" role="menuitem">Sign out</button>
              </div>
            </div>
          </header>
          
          <main class="card main">
            <slot />
          </main>
        </div>
      </div>
    </div>

    <!-- Theme management -->
    <script is:inline>
      (() => {
        const themeKey = "cis118m:theme";
        const storedTheme = localStorage.getItem(themeKey);
        
        const getSystemTheme = () => {
          return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        };
        
        let currentTheme = storedTheme || getSystemTheme();
        
        const applyTheme = (theme) => {
          currentTheme = theme;
          document.body.setAttribute("data-theme", theme);
          localStorage.setItem(themeKey, theme);
          const icon = document.getElementById("theme-icon");
          if (icon) {
            icon.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
          }
        };
        
        applyTheme(currentTheme);
        
        // Theme toggle button
        const themeToggleBtn = document.getElementById("theme-toggle-btn");
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener("click", () => {
            applyTheme(currentTheme === "dark" ? "light" : "dark");
          });
        }
        
        // Listen for system theme changes if user hasn't set preference
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
          if (!localStorage.getItem(themeKey)) {
            applyTheme(e.matches ? "dark" : "light");
          }
        });
      })();
    </script>

    <!-- Sidebar collapse behavior -->
    <script is:inline>
      (() => {
        const sidebar = document.getElementById("sidebar");
        const collapseBtn = document.getElementById("sidebar-toggle");
        const expandBtn = document.getElementById("sidebar-expand");
        const pinBtn = document.getElementById("sidebar-pin");
        const sidebarKey = "cis118m:sidebarExpanded";
        const pinKey = "cis118m:sidebarPinned";
        
        if (!sidebar || !collapseBtn || !expandBtn || !pinBtn) {
          console.error("Sidebar elements not found");
          return;
        }
        
        // Default: expanded and pinned unless explicitly changed by user
        let isExpanded = localStorage.getItem(sidebarKey) !== "false";
        let isPinned = localStorage.getItem(pinKey) !== "false";
        
        const applySidebarState = () => {
          sidebar.classList.toggle("collapsed", !isExpanded);
          sidebar.classList.toggle("pinned", isPinned);
          
          // Update pin button appearance
          const pinPath = pinBtn.querySelector('path:first-child');
          if (pinPath) {
            pinPath.setAttribute('fill', isPinned ? 'currentColor' : 'none');
          }
          pinBtn.style.opacity = isPinned ? "1" : "0.5";
          pinBtn.style.color = isPinned ? "var(--accent)" : "var(--muted)";
        };
        
        applySidebarState();
        
        collapseBtn.addEventListener("click", () => {
          isExpanded = false;
          applySidebarState();
          localStorage.setItem(sidebarKey, "false");
        });
        
        expandBtn.addEventListener("click", () => {
          isExpanded = true;
          applySidebarState();
          localStorage.setItem(sidebarKey, "true");
        });
        
        pinBtn.addEventListener("click", () => {
          isPinned = !isPinned;
          applySidebarState();
          localStorage.setItem(pinKey, String(isPinned));
        });
        
        // Auto-close sidebar when clicking outside (only if not pinned)
        document.addEventListener("click", (e) => {
          if (!isExpanded || isPinned) return;
          
          // Check if click is outside sidebar and not on toggle buttons
          if (!sidebar.contains(e.target) && 
              e.target !== expandBtn && 
              !expandBtn.contains(e.target)) {
            isExpanded = false;
            applySidebarState();
            localStorage.setItem(sidebarKey, "false");
          }
        });
      })();
    </script>

    <!-- Week menu behavior -->
    <script is:inline>
      (() => {
        const openWeekKey = "cis118m:openWeek";
        const allHeaders = document.querySelectorAll(".week-header");
        const allItems = document.querySelectorAll(".week-item");
        
        // Get current week from URL path or query params
        const getCurrentWeek = () => {
          const path = window.location.pathname;
          const match = path.match(/\/week-(\d{2})/);
          if (match) return match[1];
          
          // Check query params for editor page
          const params = new URLSearchParams(window.location.search);
          const week = params.get("week");
          if (week) return week.padStart(2, "0");
          
          // Check starter param for week extraction
          const starter = params.get("starter");
          if (starter) {
            const starterMatch = starter.match(/week-(\d+)/);
            if (starterMatch) return starterMatch[1].padStart(2, "0");
          }
          
          return null;
        };
        
        // Highlight active link
        const highlightActiveLink = () => {
          const currentPath = window.location.pathname;
          document.querySelectorAll(".week-links a").forEach(link => {
            if (link.getAttribute("href") === currentPath) {
              link.setAttribute("aria-current", "page");
            }
          });
        };
        
        // Toggle week open/closed
        const toggleWeek = (header, shouldOpen) => {
          const item = header.closest(".week-item");
          const content = item.querySelector(".week-content");
          const isOpen = item.classList.contains("isOpen");
          
          if (shouldOpen === undefined) {
            shouldOpen = !isOpen;
          }
          
          if (shouldOpen && !isOpen) {
            // Open this week
            item.classList.add("isOpen");
            header.setAttribute("aria-expanded", "true");
            content.style.maxHeight = content.scrollHeight + "px";
            
            // Save to localStorage
            const week = header.getAttribute("data-week");
            localStorage.setItem(openWeekKey, week);
            
            // Close all other weeks (single-open mode)
            allItems.forEach(otherItem => {
              if (otherItem !== item && otherItem.classList.contains("isOpen")) {
                const otherHeader = otherItem.querySelector(".week-header");
                const otherContent = otherItem.querySelector(".week-content");
                otherItem.classList.remove("isOpen");
                otherHeader.setAttribute("aria-expanded", "false");
                otherContent.style.maxHeight = "0";
              }
            });
          } else if (!shouldOpen && isOpen) {
            // Close this week
            item.classList.remove("isOpen");
            header.setAttribute("aria-expanded", "false");
            content.style.maxHeight = "0";
          }
        };
        
        // Attach click listeners
        allHeaders.forEach(header => {
          header.addEventListener("click", () => {
            toggleWeek(header);
          });
        });
        
        // Determine which week to open
        const currentWeek = getCurrentWeek();
        const savedWeek = localStorage.getItem(openWeekKey);
        const weekToOpen = currentWeek || savedWeek || "01";
        
        // Open the appropriate week
        allHeaders.forEach(header => {
          if (header.getAttribute("data-week") === weekToOpen) {
            toggleWeek(header, true);
          }
        });
        
        highlightActiveLink();
      })();
    </script>

    <!-- Progress tracking and status badges -->
    <script is:inline>
      (() => {
        const PROGRESS_KEY = "cis118m:progress";
        let cloudProgress = null;
        
        // Fetch cloud progress if logged in
        const fetchCloudProgress = async () => {
          if (!window.__auth) return;
          
          try {
            const authed = await window.__auth.isAuthed();
            if (!authed) return;
            
            const token = await window.__auth.getAccessToken();
            if (!token) return;
            
            const response = await fetch('/api/progress-get', {
              headers: {
                'Authorization': `Bearer ${token}`,
              },
            });
            
            if (response.ok) {
              const data = await response.json();
              cloudProgress = data.progress || {};
              updateStatusBadges();
            }
          } catch (err) {
            console.error('[Progress] Failed to fetch cloud progress:', err);
          }
        };
        
        const getProgress = () => {
          // Use cloud progress if available, otherwise fall back to localStorage
          if (cloudProgress) {
            return cloudProgress;
          }
          
          try {
            const data = localStorage.getItem(PROGRESS_KEY);
            return data ? JSON.parse(data) : {};
          } catch {
            return {};
          }
        };
        
        const updateStatusBadges = () => {
          const progress = getProgress();
          const statusElements = document.querySelectorAll(".lesson-status");
          
          statusElements.forEach(el => {
            const starterId = el.getAttribute("data-starter");
            const entry = progress[starterId];
            const status = entry?.status || "not_started";
            
            // Clear previous content
            el.textContent = "";
            el.className = "lesson-status";
            
            if (status === "completed") {
              el.textContent = "âœ“";
              el.classList.add("completed");
            } else if (status === "in_progress") {
              el.classList.add("in-progress");
            }
          });
        };
        
        // Expose for editor to trigger updates
        window.__updateProgress = (updatedProgress) => {
          cloudProgress = updatedProgress;
          updateStatusBadges();
        };
        
        // Fetch cloud progress on load
        fetchCloudProgress();
        
        // Update on load (for local fallback)
        updateStatusBadges();
        
        // Listen for progress updates from editor
        window.addEventListener("progressUpdated", () => {
          fetchCloudProgress();
        });
      })();
    </script>

    <!-- Simple local progress tracker (no login). -->
    <script is:inline>
      (() => {
        const KEY = "cis118m_progress_v1";

        const safeJsonParse = (s) => {
          try { return JSON.parse(s); } catch { return null; }
        };

        const load = () => {
          try {
            const raw = localStorage.getItem(KEY);
            const obj = raw ? safeJsonParse(raw) : null;
            if (obj && typeof obj === "object") return obj;
          } catch {}
          return { weeks: {} };
        };

        const save = (data) => {
          try { localStorage.setItem(KEY, JSON.stringify(data)); } catch {}
        };

        const ensureWeek = (data, week) => {
          data.weeks ||= {};
          data.weeks[week] ||= { viewed: {}, selfMarked: {}, lastUpdated: new Date().toISOString() };
          data.weeks[week].viewed ||= {};
          data.weeks[week].selfMarked ||= {};
          return data.weeks[week];
        };

        const getWeekAndSlugFromPath = () => {
          const path = window.location.pathname;
          const m = path.match(/^\/week-(\d{2})\/(.*)$/);
          if (!m) return null;
          const week = m[1];
          const rest = (m[2] || "").replace(/\/+$/, "");
          const slug = rest === "" ? "index" : rest.split("/")[0];
          return { week, slug };
        };

        const markViewed = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week, slug } = info;
          const data = load();
          const w = ensureWeek(data, week);
          const trackable = new Set(["lesson-1","lesson-2","extra-practice","lab","homework","index"]);
          if (trackable.has(slug)) {
            w.viewed[slug] = true;
            w.lastUpdated = new Date().toISOString();
            save(data);
          }
        };

        const applyProgressBadges = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week } = info;
          const data = load();
          const w = ensureWeek(data, week);

          document.querySelectorAll("[data-progress-slug]").forEach((el) => {
            const slug = el.getAttribute("data-progress-slug");
            const kind = el.getAttribute("data-progress-kind") || "viewed"; // viewed | selfMarked
            const done = kind === "selfMarked" ? !!w.selfMarked?.[slug] : !!w.viewed?.[slug];

            el.textContent = done ? "âœ… Done" : "â¬œ Not yet";
            el.setAttribute("aria-label", done ? "Done" : "Not yet");
            el.style.fontWeight = "600";
            el.style.opacity = done ? "1" : ".85";
          });
        };

        const wireMarkCompleteButtons = () => {
          const info = getWeekAndSlugFromPath();
          if (!info) return;
          const { week } = info;

          document.querySelectorAll("[data-mark-complete]").forEach((btn) => {
            const slug = btn.getAttribute("data-mark-complete");
            btn.addEventListener("click", () => {
              const data = load();
              const w = ensureWeek(data, week);
              w.selfMarked[slug] = true;
              w.lastUpdated = new Date().toISOString();
              save(data);
              applyProgressBadges();
              btn.disabled = true;
              btn.textContent = "Marked complete âœ…";
            });

            const data = load();
            const w = ensureWeek(data, week);
            if (w.selfMarked?.[slug]) {
              btn.disabled = true;
              btn.textContent = "Marked complete âœ…";
            }
          });
        };

        document.addEventListener("DOMContentLoaded", () => {
          markViewed();
          applyProgressBadges();
          wireMarkCompleteButtons();
        });
      })();
    </script>
    <script>
      import { login, logout, getUser, isAuthed, handleCallback, getAccessToken } from "../lib/auth";

      // Expose auth functions globally for use in editor
      window.__auth = {
        login,
        logout,
        getUser,
        isAuthed,
        getAccessToken,
      };

      // Auth UI management
      function qs(sel) {
        return document.querySelector(sel);
      }

      (async () => {
        if (window.__authScriptRunning) return;
        window.__authScriptRunning = true;
        
        const btnLogin = qs("[data-auth='login']");
        const userChip = qs("[data-auth='user-chip']");
        const userEmail = qs("[data-auth='user-email']");
        const dropdownMenu = qs("[data-auth='dropdown-menu']");
        const btnLogout = qs("[data-auth='logout']");

        // Check if we're returning from Auth0 callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code') && urlParams.has('state')) {
          window.location.href = '/auth/callback' + window.location.search;
          return;
        }

        await new Promise(resolve => setTimeout(resolve, 300));
        
        let authed = false;
        let user = null;
        
        try {
          authed = await isAuthed();
          user = await getUser();
        } catch (err) {
          console.error('[Auth] Error:', err);
        }

        if (user && user.email) {
          // Logged in state
          if (btnLogin) btnLogin.style.display = "none";
          if (userChip) {
            userChip.style.display = "flex";
            if (userEmail) userEmail.textContent = user.email;
            
            // Chip click toggles dropdown
            userChip.addEventListener("click", (e) => {
              e.stopPropagation();
              const isOpen = dropdownMenu.style.display === "block";
              dropdownMenu.style.display = isOpen ? "none" : "block";
              userChip.setAttribute("aria-expanded", isOpen ? "false" : "true");
            });
            
            // Keyboard support
            userChip.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                const isOpen = dropdownMenu.style.display === "block";
                dropdownMenu.style.display = isOpen ? "none" : "block";
                userChip.setAttribute("aria-expanded", isOpen ? "false" : "true");
              } else if (e.key === "Escape" && dropdownMenu.style.display === "block") {
                dropdownMenu.style.display = "none";
                userChip.setAttribute("aria-expanded", "false");
              }
            });
          }
          
          // Close dropdown when clicking outside
          if (dropdownMenu) {
            document.addEventListener("click", () => {
              dropdownMenu.style.display = "none";
              if (userChip) userChip.setAttribute("aria-expanded", "false");
            });
            
            // Close on Escape key
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && dropdownMenu.style.display === "block") {
                dropdownMenu.style.display = "none";
                if (userChip) userChip.setAttribute("aria-expanded", "false");
              }
            });
          }
          
          // Logout button
          if (btnLogout) {
            btnLogout.addEventListener("click", () => {
              // Save current location before logout
              sessionStorage.setItem('cis118m:returnTo', window.location.pathname + window.location.search);
              logout();
            });
          }
        } else {
          // Not logged in - force login
          if (!authed) {
            // Check if we have a saved return location
            const savedReturnTo = sessionStorage.getItem('cis118m:returnTo');
            if (savedReturnTo) {
              sessionStorage.removeItem('cis118m:returnTo');
              await login(savedReturnTo);
            } else {
              await login(window.location.pathname + window.location.search);
            }
          } else {
            // Edge case: authed but no user - show login button
            if (btnLogin) {
              btnLogin.style.display = "inline-flex";
              btnLogin.addEventListener("click", () => login(window.location.pathname + window.location.search));
            }
            if (userChip) userChip.style.display = "none";
          }
        }
      })();
    </script>
  </body>
</html>
