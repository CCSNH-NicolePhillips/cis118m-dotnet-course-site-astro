---
// Lab Tour Component - Spotlight walkthrough for lab assignments
// Auto-starts on first visit, with button to restart
---

<div class="tour-container">
  <button id="start-lab-tour-btn" class="start-tour-btn">
    üéØ Take the Lab Tour
  </button>
</div>

<div id="tour-overlay" class="tour-overlay">
  <svg id="tour-backdrop" class="tour-backdrop"></svg>
  <div id="tour-tooltip" class="tour-tooltip">
    <div id="tour-step-indicator" class="tour-step-indicator"></div>
    <div id="tour-content" class="tour-content"></div>
    <div class="tour-buttons">
      <button id="tour-skip-btn" class="tour-skip-btn">Skip Tour</button>
      <button id="tour-next-btn" class="tour-next-btn">Next ‚Üí</button>
    </div>
  </div>
</div>

<style>
  .tour-container {
    margin: 16px 0;
    text-align: center;
  }

  .start-tour-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, rgba(78, 201, 176, 0.15), rgba(78, 201, 176, 0.25));
    border: 2px solid #4ec9b0;
    border-radius: 10px;
    color: #4ec9b0;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .start-tour-btn:hover {
    background: linear-gradient(135deg, rgba(78, 201, 176, 0.25), rgba(78, 201, 176, 0.35));
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(78, 201, 176, 0.3);
  }

  .tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 10000;
    display: none;
    pointer-events: none;
  }

  .tour-overlay.active {
    display: block;
  }

  .tour-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: auto;
  }

  .tour-tooltip {
    position: fixed;
    background: linear-gradient(135deg, #1a2332, #0f172a);
    border: 2px solid #4ec9b0;
    border-radius: 16px;
    padding: 20px 24px;
    max-width: 400px;
    min-width: 300px;
    color: #f1f5f9;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(78, 201, 176, 0.2);
    z-index: 10002;
    pointer-events: auto;
  }

  .tour-step-indicator {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    justify-content: center;
  }

  .tour-step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #334155;
  }

  .tour-step-dot.active {
    background: #4ec9b0;
    box-shadow: 0 0 10px rgba(78, 201, 176, 0.5);
  }

  .tour-step-dot.completed {
    background: #22c55e;
  }

  .tour-content {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 20px;
  }

  .tour-content :global(h4) {
    margin: 0 0 10px 0;
    font-size: 1.15rem;
    color: #4ec9b0;
  }

  .tour-content :global(p) {
    margin: 0;
    color: #cbd5e1;
  }

  .tour-buttons {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }

  .tour-skip-btn {
    padding: 10px 16px;
    background: transparent;
    border: 1px solid #475569;
    border-radius: 8px;
    color: #94a3b8;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .tour-skip-btn:hover {
    background: rgba(71, 85, 105, 0.3);
    color: #f1f5f9;
  }

  .tour-next-btn {
    padding: 10px 24px;
    background: linear-gradient(135deg, #4ec9b0, #22c55e);
    border: none;
    border-radius: 8px;
    color: #0f172a;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
    flex: 1;
    max-width: 140px;
  }

  .tour-next-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(78, 201, 176, 0.4);
  }
</style>

<script>
  (function() {
    const tourSteps = [
      {
        selector: '#lab-editor',
        title: '‚úçÔ∏è Your Code Editor',
        text: 'This is where you write your C# code!<br><br><strong>Toolbar buttons:</strong><br>‚Ä¢ <strong>Save</strong> - saves your work to this browser<br>‚Ä¢ <strong>Reset</strong> - restore starter code<br>‚Ä¢ <strong>Download</strong> - save a .cs file',
        position: 'bottom'
      },
      {
        selector: '#lab-editor',
        title: '‚ñ∂Ô∏è Run & Check',
        text: '<strong>Green Run button</strong> - compile and run your code. Output appears in the drawer below.<br><br><strong>Run Checks button</strong> - see which requirements you\'ve completed. Fix what\'s red!',
        position: 'bottom'
      },
      {
        selector: '.ai-tutor-button',
        title: 'ü§ñ AI Tutor',
        text: 'Stuck? Click this button in the corner!<br><br>The AI can see your code and will help guide you with questions and hints (without giving away the answer).',
        position: 'left'
      },
      {
        selector: '#submit-section',
        title: 'üì§ Submit Your Work',
        text: 'When all your checks pass, scroll down and click <strong>Submit Lab for Grading</strong>.<br><br>You\'ll get instant AI feedback and your score!',
        position: 'top'
      },
      {
        selector: null,
        title: 'üéâ You\'re Ready!',
        text: 'That\'s it! Read the requirements above, write your code, and don\'t forget to submit when you\'re done.<br><br>Good luck and have fun!',
        position: 'center'
      }
    ];

    let currentStep = 0;
    let overlay, backdrop, tooltip, content, stepIndicator, nextBtn, skipBtn;

    function init() {
      overlay = document.getElementById('tour-overlay');
      backdrop = document.getElementById('tour-backdrop');
      tooltip = document.getElementById('tour-tooltip');
      content = document.getElementById('tour-content');
      stepIndicator = document.getElementById('tour-step-indicator');
      nextBtn = document.getElementById('tour-next-btn');
      skipBtn = document.getElementById('tour-skip-btn');
      
      const startBtn = document.getElementById('start-lab-tour-btn');
      if (startBtn) startBtn.addEventListener('click', startTour);
      if (nextBtn) nextBtn.addEventListener('click', nextStep);
      if (skipBtn) skipBtn.addEventListener('click', endTour);
      
      // Auto-start disabled for now
      // const tourKey = 'cis118m:lab-tour-completed:' + window.location.pathname;
      // if (!localStorage.getItem(tourKey)) {
      //   setTimeout(startTour, 1000);
      // }
    }

    function startTour() {
      currentStep = 0;
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      showStep();
    }

    function showStep() {
      const step = tourSteps[currentStep];
      
      // Update step dots
      stepIndicator.innerHTML = tourSteps.map((_, i) => 
        `<div class="tour-step-dot ${i === currentStep ? 'active' : ''} ${i < currentStep ? 'completed' : ''}"></div>`
      ).join('');
      
      // Update content
      content.innerHTML = `<h4>${step.title}</h4><p>${step.text}</p>`;
      
      // Update button
      nextBtn.textContent = currentStep === tourSteps.length - 1 ? 'Got it!' : 'Next ‚Üí';
      
      if (step.selector) {
        const element = document.querySelector(step.selector);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => highlightElement(element, step.position), 400);
        } else {
          showCentered();
        }
      } else {
        showCentered();
      }
    }

    function highlightElement(element, position) {
      const rect = element.getBoundingClientRect();
      const padding = 16;
      
      // Calculate hole dimensions
      const holeX = rect.left - padding;
      const holeY = rect.top - padding;
      const holeW = rect.width + padding * 2;
      const holeH = rect.height + padding * 2;
      const cornerRadius = 12;
      
      // Create SVG mask with rounded rectangle hole
      const w = window.innerWidth;
      const h = window.innerHeight;
      
      backdrop.innerHTML = `
        <defs>
          <mask id="hole-mask">
            <rect x="0" y="0" width="${w}" height="${h}" fill="white"/>
            <rect x="${holeX}" y="${holeY}" width="${holeW}" height="${holeH}" rx="${cornerRadius}" fill="black"/>
          </mask>
        </defs>
        <rect x="0" y="0" width="${w}" height="${h}" fill="rgba(0,0,0,0.75)" mask="url(#hole-mask)"/>
        <rect x="${holeX}" y="${holeY}" width="${holeW}" height="${holeH}" rx="${cornerRadius}" 
              fill="none" stroke="#4ec9b0" stroke-width="3"
              style="filter: drop-shadow(0 0 10px rgba(78,201,176,0.5))"/>
      `;
      
      // Position tooltip
      positionTooltip(rect, position);
    }

    function showCentered() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      
      backdrop.innerHTML = `
        <rect x="0" y="0" width="${w}" height="${h}" fill="rgba(0,0,0,0.75)"/>
      `;
      
      // Center tooltip
      tooltip.style.top = '50%';
      tooltip.style.left = '50%';
      tooltip.style.transform = 'translate(-50%, -50%)';
    }

    function positionTooltip(rect, position) {
      tooltip.style.transform = 'none';
      
      const tooltipRect = tooltip.getBoundingClientRect();
      const gap = 20;
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      
      let top, left;
      
      switch (position) {
        case 'bottom':
          top = rect.bottom + gap;
          left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
          break;
        case 'top':
          top = rect.top - tooltipRect.height - gap;
          left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
          break;
        case 'left':
          top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
          left = rect.left - tooltipRect.width - gap;
          break;
        case 'right':
          top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
          left = rect.right + gap;
          break;
        default:
          showCentered();
          return;
      }
      
      // Keep in viewport
      if (left < 10) left = 10;
      if (left + tooltipRect.width > vw - 10) left = vw - tooltipRect.width - 10;
      if (top < 10) top = 10;
      if (top + tooltipRect.height > vh - 10) top = vh - tooltipRect.height - 10;
      
      tooltip.style.top = `${top}px`;
      tooltip.style.left = `${left}px`;
    }

    function nextStep() {
      currentStep++;
      if (currentStep < tourSteps.length) {
        showStep();
      } else {
        endTour();
      }
    }

    function endTour() {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
      backdrop.innerHTML = '';
      
      const tourKey = 'cis118m:lab-tour-completed:' + window.location.pathname;
      localStorage.setItem(tourKey, 'true');
      
      window.dispatchEvent(new Event('tourCompleted'));
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
